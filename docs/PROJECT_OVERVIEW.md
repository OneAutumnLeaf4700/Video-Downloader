# Video Downloader – Project Overview and Guide

This document explains the project at a glance: what each file/folder does, how the app runs, how downloads flow through the system, how to build a distributable executable, and where to extend or modify functionality. It assumes no prior knowledge of the codebase.

## What this app is
A cross‑platform GUI application built with Python and PyQt6 that uses `yt-dlp` to download content from 100+ sites. It supports:
- MP4 video downloads (with resolution selection)
- MP3 audio extraction (via FFmpeg)
- Playlist downloads
- Multi‑threaded queue with progress updates

## Quick start
- From source:
  1) Create a venv and install requirements
     - Windows (PowerShell):
       ```powershell
       py -m venv venv
       .\venv\Scripts\activate
       pip install -r requirements.txt
       ```
  2) Run the app
     ```powershell
     python main.py
     ```
- Single‑file EXE (Windows):
  - Build
    ```powershell
    pip install pyinstaller
    pyinstaller --noconfirm --onefile --windowed --name VideoDownloader --add-data "src\gui\style.qss;gui" src\gui\app.py
    ```
  - Run: `dist\VideoDownloader.exe`

Notes:
- For MP3 conversion, FFmpeg must be installed and on PATH. See `https://ffmpeg.org/download.html`.

---

## High-level architecture
- GUI layer (PyQt6): input, controls, progress, and status updates.
- Queue/worker layer: manages concurrent downloads and progress callbacks.
- Download layer (yt‑dlp): fetches media and optionally post‑processes with FFmpeg.
- Utilities/config: constants and folder helpers.

Data flow:
1) User enters URL and selects options in the GUI.
2) GUI adds a task to the multi‑threaded queue.
3) Worker threads call the download function, emitting progress.
4) GUI updates progress bars and lists via thread‑safe signals.
5) yt‑dlp writes files to the organized folder structure.

---

## Repository layout and file-by-file purpose

Top-level
- `main.py`
  - Minimal entry point that imports and calls `src.gui.app.run_app()`.
  - Use this to run the app during development.
- `requirements.txt`
  - Runtime dependencies (PyQt6, yt‑dlp).
- `README.md`
  - Project readme for quick user guidance and build instructions (high level).
- `LICENSE`
  - MIT license for the project.
- `setup.py`
  - Packaging metadata (name, version, install requirements). Useful if publishing to PyPI or installing via pip in editable mode.
- `build.py` (optional utility)
  - Helper script for packaging (not strictly required; PyInstaller commands are shown above).
- `pyproject.toml`, `MANIFEST.in`, `video_downloader.spec` (if present)
  - Build/packaging configs. The `.spec` file is auto‑generated by PyInstaller on first build.

Documentation
- `docs/`
  - `PROJECT_OVERVIEW.md` (this file): in‑depth explanation of the codebase.
  - `usage.md`: end‑user usage guide.
  - `screenshots/`: images used in docs.

Downloaded content (runtime output)
- `downloaded_content/`
  - `mp4/` and `mp3/`: top‑level folders by format.
  - `videos/` and `playlists/`: second‑level folders by content type.
  - Inside these, the app creates per‑video or per‑playlist subfolders.

Source code (app code lives under `src/`)
- `src/config.py`
  - Central place to keep constants or app‑wide configuration defaults (if used by the GUI or downloader).
- `src/utils/`
  - `folder_utils.py`: helpers for dealing with directories, paths, or file‑system safety (e.g., sanitizing names). Some of this logic also exists directly in the downloader for clarity.
- `src/gui/` (GUI layer)
  - `app.py`
    - Creates the `QApplication`, loads stylesheet, and shows the `MainWindow`.
    - Contains logic to locate the `style.qss` file both in source and in PyInstaller one‑file builds (via `_MEIPASS`).
    - Import strategy is resilient to being run as a module (`python -m`) or as a PyInstaller “script”.
  - `main_window.py`
    - The primary window class. Responsible for:
      - Input fields: URL, save directory, format (MP4/MP3), resolution.
      - Controls: browse for folder, download button, playlist check.
      - Progress: a progress bar and a queue list that shows each task state.
      - Status: a status label that summarizes current queue activity.
      - Queue callbacks: thread‑safe bridging of background progress/events into the GUI using a small signal class.
      - Error dialogs: uses `QMessageBox.critical` for user‑visible errors.
      - Interactions: collects options and enqueues downloads via the `DownloadQueueManager`.
  - `worker.py`
    - `DownloaderWorker` type for running a download function in a Qt worker object (signal‑based progress). The current implementation primarily uses the thread queue in `queue_manager.py`; this class remains available for future direct Qt‑thread integrations.
  - `style.qss`
    - Application stylesheet (modern/dark look). Bundled into the EXE via `--add-data`.
- `src/video_downloader/` (download & queue layer)
  - `downloader.py`
    - Core integration with `yt_dlp`. Main function: `download_video(url, ...)`.
    - Responsibilities:
      - Option preparation for single video vs playlist.
      - Format selection: MP4 (video) or MP3 (audio). For MP3, adds FFmpeg audio post‑processor; for MP4, adds a convertor post‑processor.
      - Resolution constraints for videos, e.g., `height<=720`.
      - Folder organization (if enabled):
        - Builds a structured path under `downloaded_content/` by format and type.
        - Sanitizes names to be filesystem‑safe.
      - Info helpers: `get_video_info`, `get_playlist_info` for friendly logging/UX.
      - Progress hook integration for per‑item updates and error bookkeeping.
      - Error handling: collects failures during batch/playlist operations and raises a summarized `DownloadError` if required.
    - External requirements: FFmpeg must be on PATH for MP3 extraction and some MP4 conversions.
  - `queue_manager.py`
    - Multi‑threaded queue for downloads.
    - Types:
      - `DownloadStatus` enum for task states.
      - `DownloadTask` dataclass for task metadata, progress, and result state.
    - `DownloadQueueManager`:
      - Adds tasks, starts a pool of daemon threads, and processes tasks until empty or stopped.
      - Emits callbacks for started/progress/completed/failed/queue_empty.
      - Computes progress percentage as `downloaded_bytes / total_bytes` when available.
      - Thread‑safety via a lock for access to shared structures.

---

## How the download flow works
1) User fills options and clicks Download in `MainWindow`.
2) `MainWindow.start_download()` constructs an options dict (output path pattern, format, resolution, playlist flag) and calls `DownloadQueueManager.add_download(url, options)`.
3) Queue manager enqueues a `DownloadTask` and, if needed, starts worker threads.
4) Worker thread:
   - Marks the task as `DOWNLOADING` and emits `on_task_started`.
   - Attaches a `progress_hook` so that yt‑dlp progress is converted to a percentage and emitted to the GUI.
   - Calls `download_video(...)` with the prepared options.
   - On success: marks `COMPLETED` and emits `on_task_completed`.
   - On error: marks `FAILED` and emits `on_task_failed` with the error string.
5) `MainWindow` updates the progress bar, queue list, and status label via thread‑safe signals bridged to the UI thread.

---

## Common issues and fixes
- FFmpeg not found / MP3 conversion fails
  - Symptom: errors when choosing MP3 (or when converting video to MP4).
  - Fix: install FFmpeg and ensure `ffmpeg` is on your PATH.
- Playlist errors (some items fail)
  - Behavior: the downloader may skip broken/private videos and continue.
  - The summary log will indicate how many items failed vs succeeded.
- Firewall or network restrictions
  - `yt_dlp` cannot retrieve content; try a different network, VPN, or update yt‑dlp.
- Windows SmartScreen / antivirus warning for EXE
  - The EXE is unsigned. You can keep it local or sign it with a code signing certificate if distributing.

---

## Where to add improvements
- GUI/UX
  - Add per‑item controls (pause/cancel), tooltips, or history.
  - Drag‑and‑drop URL support.
  - Better error banners instead of modal dialogs.
- Download features
  - Add bitrate selection for MP3, or merge audio+video with explicit container choices.
  - Add subtitles download option (yt‑dlp supports this).
- Queue & performance
  - Persist queue state to disk and resume on restart.
  - Throttling or bandwidth limiting.
- Configuration
  - Add a settings dialog (default folder, default format/resolution, concurrent workers).
- Packaging & distribution
  - Add icons, version metadata, and a custom installer.

---

## Glossary
- PyQt6: Python bindings for the Qt 6 GUI toolkit.
- yt‑dlp: Active fork of youtube‑dl, supports many sites and advanced features.
- FFmpeg: Multimedia framework used for audio/video transcoding.
- PyInstaller: Packages Python apps into standalone executables.

---

## Appendix: Key classes and functions
- `MainWindow` (GUI): central application window, wires together user inputs and queue events.
- `DownloadQueueManager` (queue): adds tasks, runs background worker threads, and emits callbacks.
- `DownloadTask` (dataclass): task state for a single URL.
- `download_video(url, ...)` (downloader): bridges GUI options to yt‑dlp configuration and post‑processing.

If you read this top‑to‑bottom, you now know what each module does, how they interact, how to run/debug the app, and where to start when adding features.
